# Grin wallet APIs and security model

## Abstract

This document defines the standards for grin, a minimalist implementation of the
mimblewimble protocol, regarding the interactions between the wallet containing a
secret seed and transaction outputs, and various clients that need to access the
wallet, also called wallet API.

By various clients we mean : the grin server mining process, which adds new minted
coins to the wallet; other grin wallets, which may send funds to each other; and
ultimately GUI and web clients which might be implemented by third parties in order
to provide various services on the mimblewimble blockchain via grin.

## Motivation

The purpose of this document is to establish a well reviewed set of specifications
for any interactions between the grin wallet and various software that need to
access it. By establishing those specifications, we hope to give sound security
to the wallet so that it is as protected as possible from unauthorized access to
its seed and transactions, which would result in fatal losses of funds and/or
privacy for the wallet user.

# Specifications : global change for the wallet listening processes

## Communications Security

We propose to upgrade the current use of _hyper_ acting as a HTTP server to
_rustls + hyper-rustls_ which will provide security advantages over other libraries
such as hyper_native_tls for example. See https://docs.rs/rustls/0.12.0/rustls/

Regarding cyphers to use for generating the required public/private key pairs,
we could use AES keys which can be generated by the openssl library already part
of grin codebase. More info about using better ssl cyphers can be found here
https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/

The user should be able to use their own SSL certificates (we could show a warning
if those present potential security issues), or ask/let grin generate some on the fly
if no certificate is found.

The wallet operations (such as getting info, requesting to send funds, etc) should be
protected with a username and password that can be set via the command line options or
the grin.toml configuration file. This will forbid unauthorized users to access the
wallet while not requiring the wallet passphrase to be sent by the client.

For even better security, the existing wallet receiver listener and the new wallet operator
listener could run by default on https:// and there would not be the option to
use them without TLS encryption. This might require changes in the miner part to accommodate
requesting coinbase information over https:// protocol, and the wallet sending part, as self
signed SSL certificates usually gererate errors and/or warnings in https requests.

Another idea that could improve security for the wallet : since we probably want the grin server
to run on a public ip address so it can communicate with other peers, we could also add a
transaction forwarder in the server api, allowing remote grin wallet to send funds to
the wallet behind the server (which does not host a wallet itself).

So the grin server would listen on a public IP on port 13515 and then forward any incoming
receive transaction API call to the wallet listener which would run on a local machine on a 
local network which cannot be reached from outside. Then even if the grin server
system is compromised, the wallet would remain safe, while allowing remote wallet transactions
to be received.  

# Specifications : wallet receiver API

This listener is already implemented in milestone/testnet1 and runs by default on
127.0.0.1:13415.

## Global specifications of the listener

### Current specifications

The listener is a HTTP server expecting either GET requests or POST requests with
JSON encoded data. Thereâ€™s no encryption or password protection on the listener
requests. The listener can be configured to listen on 0.0.0.0 (as it is necessary
when we want the wallet to be able to receive transactions from other wallets from
internet).

### Proposed specifications

#### Configuration settings changes

We propose to split the configuration and code for wallet receiving and operation
activities in two, so that they can be configured separately. For example the user
might choose to keep his "receiving" listener open on the internet to allow other
grin wallets to send funds, while leaving the "operations" listener open on 127.0.0.1
only (which seems to be preferable in most cases).

We'll change the current concept of wallet listener to become the
"wallet receiver listener" to contrast against the "wallet operator listener"
we'll describe later in this document.

So in the configuration and the code we'll change references to "wallet listener"
to "wallet receiver listener". For example in src/bin/grin.rs the line :

_wallet_config.api_listen_interface will_ become
_wallet_config.api_receiver_listen_interface_

_wallet_config.api_listen_port_ will become
_wallet_config.api_receiver_listen_port_

and so on.

The following command line options will be altered :

_-e, --external
Listen on 0.0.0.0 interface to allow external connections (default is 127.0.0.1)_

will become

_-e, --external-receiver
Listen on 0.0.0.0 interface to allow external receiver connections
(default is 127.0.0.1)_

#### Communications security

All API calls would have to go through HTTPS.

#### Process Isolation

**[todo]**

@ignopeverell "Process isolation is likely required. Maybe a dedicated key server segregated
from the rest just for the purpose of manipulating keys exposing a very limited set of operations
and with restrictions?"

## API endpoint : v1/receive/coinbase

Usage : the grin server mining process needs to ask the wallet to supply information
needed in order to credit the wallet with the reward generated when mining a new
block.

### Current specifications for v1/receive/coinbase

#### Access point URI

The API is accessed via a POST request to the following url :
wallet_listener_url/v1/receive/coinbase

Where wallet_listener_url is defined either by an entry in the grin.toml config :

[mining]

**wallet_listener_url = "http://127.0.0.1:13415"**

Or a command line parameter :

**grin server -w  http://127.0.0.1:13415**

_Values Expected_

This API expects a struct BlockFees passed as a json encoded value POST data. 

BlockFees is already defined in grin.

_Values Returned_

This API returns a struct CbData as json encoded response with HTTP 200 status
if everything went fine, or a HTTP 400 error response otherwise.

CbData is already defined in grin.

### Proposed specifications for v1/receive/coinbase

#### Access point

No change proposed.

## API endpoint : v1/receive/transaction

Usage : a remote grin wallet wants to send a new transaction to the local wallet.

### Current specification for v1/receive/transaction

_Access point URI_

The API is accessed via a POST request to the following url :
wallet_listener_url/v1/receive/transaction

Where wallet_listerner_url is specified by the sender on the command line with the -d parameter as following :
grin wallet send -d http://xxx.xxx.xxx.xxx:13415 10.00

_Values Expected_

This API expects a struct PartialTx passed as a json encoded value POST data. 

PartialTx is already defined in grin.

_Values Returned_

This API returns a HTTP 200 success response if everything went fine, or a HTTP 400 error response otherwise.

### Proposed specifications for v1/receive/transaction

#### Access point

No change proposed.

# Specifications : wallet operator API

This API is a new proposal and is not implemented yet. The overall goal of this API is to allow third party applications to access the wallet (for example to query the available balances) and instruct it to perform operations (for example to send funds to another wallet).
One typical usage of this API would be when a GUI for end-users to use the grin wallet which is currently only working in a terminal.

## Global specifications of the operator listener

### Current specifications

None

### Proposed specifications

#### Configuration settings

We'll add a new "wallet operator listener" which will be configurable in a very
similar way, with for example :

**wallet_config.api_operator_listen_interface**
**wallet_config.api_operator_listen_port**

and so on.

The following configuration entries will be added :

* wallet_config.api_operator_listen_interface
* wallet_config.api_operator_listen_port
* wallet_config.api_operator_rpc_user
* wallet_config.api_operator_rpc_password

Two new command line options will be added :

* -o, --operator_port <operator_port>
Port on which to run the wallet operator listener
* -f, --external-operator
Listen on 0.0.0.0 interface to allow external operator connections
(default is 127.0.0.1)
* -u, --operator_user <username>
Username to use to access the operator api
* -p, --operator_password <password>
Password to use to access the operator api

#### Communications security

All API calls would have to go through HTTPS and supply the required rpc username/password
via HTTP auth mechanism.

#### Process Isolation

**[todo]**

## API endpoint : v1/info/balances

Usage : a GUI client wants to know how much funds are available in the wallet

### Current specification for v1/info/balances

None

### Proposed specification for v1/info/balances

#### Access point

_Access point URI_

The API is accessed via a GET request to the following url :
wallet_operator_listener_url/v1/info/balances

_Values Expected_

None

_Values Returned_

This API returns a struct WalletInfoData as json encoded response with HTTP 200 status
if everything went fine, or a HTTP 400 error response otherwise.

The values in the response are formatted by grin via amount_to_hr_string() as they are
on the command line.

WalletInfoData is not defined yet in grin, but could look like this :

pub struct WalletInfoData {
	pub unspent_total: String,
	pub unspent_but_locked_total: String,
	pub unconfirmed_total: String,
	pub locked_total: String,
}

## API endpoint : v1/info/balances/raw

Usage : a GUI client wants to know how much funds are available in the wallet, without formatting

### Current specification for v1/info/balances/raw

None

### Proposed specification for v1/info/balances/raw

#### Access point

_Access point URI_

The API is accessed via a GET request to the following url :
wallet_operator_listener_url/v1/info/balances/raw

_Values Expected_

None

_Values Returned_

This API returns a struct WalletInfoRawData as json encoded response with HTTP 200 status
if everything went fine, or a HTTP 400 error response otherwise.

WalletInfoRawData is not defined yet in grin, but could look like this :

pub struct WalletInfoRawData {
	pub unspent_total: u64,
	pub unspent_but_locked_total: u64,
	pub unconfirmed_total: u64,
	pub locked_total: u64,
}

## API endpoint : v1/transaction/send

Usage : a GUI client wants to instruct the wallet to send funds to another wallet

### Current specification for v1/transaction/send

None

### Proposed specification for v1/transaction/send

#### Access point

_Access point URI_

The API is accessed via a POST request to the following url :
wallet_operator_listener_url/v1/transaction/send

_Values Expected_

This API expects a struct SendTx passed as a json encoded value POST data.

SendTx is not defined yet in grin, but could look like this :

pub struct SendTx {
	pub amount: String,
	pub minimum_confirmations: u64,
	pub dest: String,
	pub selection_strategy: String,
}

_Values Returned_

This API returns a struct WalletSendResult as json encoded response with HTTP 200 status
if everything went fine, or a HTTP 400 error response otherwise.

WalletSendResult is not defined yet in grin, but could look like this :

pub struct WalletSendResult {
	pub confirmed: bool,
}

Or we could rely just on the HTTP 200 status to signal that sending was successful.

## API endpoint : v1/info/server/chain

Usage : a GUI client wants to know what is the current status of the chain on the server
behind the wallet to show for example the current chain height

### Current specification for v1/info/server/chain

None; but the grin server offers this info on v1/chain

### Proposed specification for v1/info/server/chain

The grin wallet operator would forward the response it gets from the grin server to the
end-user client

#### Access point

_Access point URI_

The API is accessed via a GET request to the following url :
wallet_operator_listener_url/v1/info/server/chain

_Values Expected_

None

_Values Returned_

This API returns a struct Tip as json encoded response with HTTP 200 status
if everything went fine, or a HTTP 400 error response otherwise.

Tip is already defined in grin.

## API endpoint : v1/info/server/peers

Usage : a GUI client wants to know what is the current status of the known peers on the
server behind the wallet, for example the number of connected peers

#### Current specification for v1/info/server/peers

None; but the grin server offers this info on v1/peers/connected and v1/peers/all

### Proposed specification for v1/info/server/peers

#### Access point

_Access point URI_

The API is accessed via a GET request to the following url :
wallet_operator_listener_url/v1/info/server/peers

_Values Expected_

None

_Values Returned_

This API returns an array of peers as json encoded response with HTTP 200 status
if everything went fine, or a HTTP 400 error response otherwise.

The returned array could be formatted this way :

{
  [
    { "peer_id" : "<id>", "peer_address" : "<ip address:port>", "peer_connected" : "true" }
    { "peer_id" : "<id>", "peer_address" : "<ip address:port>", "peer_connected" : "false" }
    ...
    { "peer_id" : "<id>", "peer_address" : "<ip address:port>", "peer_connected" : "true" }
  ]
}

Alternatively, the response might also be a struct encoded via json to make it easier to maintain
the proper format if it evolves with time.

## API endpoint : v1/info/server/pool

Usage : a GUI client wants to know details of the transactions pool on the server
behind the wallet, for example the number of transactions inside the pool

### Current specification for v1/server/pool

None; but the grin server offers this info on v1/pool

### Proposed specification for v1/server/pool

#### Access point

_Access point URI_

The API is accessed via a GET request to the following url :
wallet_operator_listener_url/v1/info/server/pool

_Values Expected_

None

_Values Returned_

This API returns a struct PoolInfo as json encoded response with HTTP 200 status
if everything went fine, or a HTTP 400 error response otherwise.

PoolInfo is already defined in grin.